<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Sync - Timezone Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --bg-deep: #020617;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
            --accent-home: #f59e0b;
            --forbidden-zone: rgba(239, 68, 68, 0.08); /* Soft red for sleep hours */
            --left-col-width: 18rem;
        }

        body {
            background-color: var(--bg-deep);
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            min-height: 100vh;
            color: #f8fafc;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
        }

        .hour-marker {
            position: absolute;
            height: 100%;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 1;
        }

        .forbidden-overlay {
            background: var(--forbidden-zone);
            position: absolute;
            top: 0;
            bottom: 0;
            z-index: 1;
            pointer-events: none;
        }

        .business-hours {
            background: linear-gradient(180deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.25) 100%);
            border-left: 1px solid rgba(16, 185, 129, 0.3);
            border-right: 1px solid rgba(16, 185, 129, 0.3);
            z-index: 2;
        }

        .home-city-row {
            background: rgba(245, 158, 11, 0.03);
            border-left: 4px solid var(--accent-home);
        }

        .common-time-highlight {
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.15) 100%);
            border-left: 2px solid var(--accent-blue);
            border-right: 2px solid var(--accent-blue);
            z-index: 5;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .current-time-marker {
            width: 2px;
            background: #ef4444;
            height: 100%;
            position: absolute;
            z-index: 30;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            pointer-events: none;
        }

        .scrubber-line {
            width: 2px;
            background: rgba(255, 255, 255, 0.4);
            height: 100%;
            position: absolute;
            z-index: 40;
            pointer-events: none;
        }

        .scrubber-label {
            position: absolute;
            transform: translateX(-50%);
            background: #ffffff;
            color: #020617;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 800;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            pointer-events: none;
            transition: left 0.1s linear;
        }

        .suggestion-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .suggestion-card:hover {
            background: rgba(59, 130, 246, 0.08);
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-4px);
        }

        .city-row:hover .remove-btn, .city-row:hover .home-btn { opacity: 1; }
        .remove-btn, .home-btn { opacity: 0; transition: opacity 0.2s; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.15); }

        @media (max-width: 768px) {
            :root { --left-col-width: 100%; }
            .city-row { flex-direction: column; align-items: stretch; padding: 1rem !important; }
            .city-row > div:first-child { width: 100% !important; position: relative !important; padding-left: 0 !important; padding-right: 0 !important; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.5rem; }
            .group\/grid { height: 6rem !important; }
            header { gap: 1.5rem !important; }
            #suggestionsPanel { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col font-sans selection:bg-blue-500/30 overflow-hidden">
    <div class="flex-1 flex flex-col max-w-[1600px] mx-auto w-full p-4 md:p-8 overflow-hidden">
        <header class="shrink-0 mb-6 flex flex-col xl:flex-row xl:items-center justify-between gap-6">
            <div class="space-y-1">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-emerald-500 flex items-center justify-center shadow-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" class="text-white" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-emerald-400 to-indigo-400">Global Sync</h1>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2 bg-white/5 rounded-lg px-3 border border-white/5 h-12">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Duration</span>
                    <select id="durationSelect" onchange="updateDuration(this.value)" class="bg-transparent py-4 text-[10px] font-bold text-blue-400 focus:outline-none cursor-pointer">
                        <option value="0.5" class="bg-slate-900">30m</option>
                        <option value="1" class="bg-slate-900" selected>1h</option>
                        <option value="2" class="bg-slate-900">2h</option>
                    </select>
                </div>
                <button id="futureToggle" onclick="toggleFuture()" class="glass px-5 h-12 text-[10px] font-black uppercase tracking-[0.2em] transition-all flex items-center gap-3 border-white/5 text-slate-500 hover:text-blue-400" title="Verifies if any timezones change (DST) in the next 7 days.">
                    <div id="futureStatusDot" class="w-2 h-2 rounded-full bg-slate-700 transition-all"></div>
                    Verify DST Shift
                </button>
                <div class="relative group h-12">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none text-slate-500 group-focus-within:text-blue-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    <input type="text" id="citySearch" placeholder="Search Location..."
                        class="glass pl-10 pr-4 h-full w-64 transition-all bg-white/5 border-white/10 hover:border-white/20 focus:bg-white/10 text-sm">
                    <div id="searchResults" class="absolute top-full left-0 right-0 mt-2 glass z-[100] hidden max-h-60 overflow-y-auto shadow-2xl bg-slate-900/95"></div>
                </div>
                <button onclick="suggestMeetings()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 h-12 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-emerald-600/20 flex items-center gap-2">
                    Find Slots
                </button>
            </div>
        </header>

        <div id="suggestionsPanel" class="hidden shrink-0 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>

        <div class="flex-1 min-h-0 glass p-6 mb-6 overflow-hidden relative shadow-inner flex flex-col">
            <div id="statusNotice" class="shrink-0 mb-4 flex flex-wrap items-center gap-4">
                <div id="goldenHourNotice" class="hidden py-1.5 px-4 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[9px] font-black uppercase tracking-[0.2em] flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse"></span>
                    Ideal Window
                </div>
                <div id="homeNotice" class="hidden py-1.5 px-4 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-400 text-[9px] font-black uppercase tracking-[0.2em] flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                    Social Guardrail Active
                </div>
            </div>

            <div class="flex-1 overflow-x-auto overflow-y-auto pb-4 custom-scrollbar">
                <div class="min-w-[1200px] relative">
                    <div id="citiesList" class="space-y-4 relative min-h-full">
                        <div id="commonTimeOverlay" class="absolute top-0 bottom-0 pointer-events-none hidden common-time-highlight"></div>
                        <div id="scrubber" class="absolute top-0 bottom-0 hidden pointer-events-none z-[60]">
                            <div class="scrubber-line"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="shrink-0 flex flex-wrap gap-6 opacity-40 hover:opacity-80 transition-opacity">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-emerald-500/30 border border-emerald-500/50"></div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Business (9a-9p)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-red-500/10 border border-red-500/20"></div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Forbidden (11p-7a)</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded border-l-2 border-amber-500 bg-amber-500/10"></div>
                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Home Base</span>
            </div>
        </div>
    </div>

    <script>
        const ALL_TIMEZONES = Intl.supportedValuesOf('timeZone');
        const CITY_DATA = ALL_TIMEZONES.map(tz => {
            const parts = tz.split('/');
            return { city: parts.pop().replace(/_/g, ' '), region: parts.join(' / ').replace(/_/g, ' '), timezone: tz };
        });

        function getTimezoneOffset(tz, baseTime = new Date()) {
            try {
                const utcDate = new Date(baseTime.toLocaleString('en-US', { timeZone: 'UTC' }));
                const tzDate = new Date(baseTime.toLocaleString('en-US', { timeZone: tz }));
                return (tzDate.getTime() - utcDate.getTime()) / 36e5;
            } catch (e) { return 0; }
        }

        function isDSTImminent(timezone, daysLimit = 7, baseDate = new Date()) {
            const currentOffset = getTimezoneOffset(timezone, baseDate);
            for (let i = 1; i <= daysLimit; i++) {
                const futureDate = new Date(baseDate.getTime() + i * 24 * 36e5);
                const futureOffset = getTimezoneOffset(timezone, futureDate);
                if (futureOffset !== currentOffset) return { imminent: true, currentOffset, nextOffset: futureOffset, daysUntil: i, nextDate: futureDate };
            }
            return { imminent: false, currentOffset };
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = date.toLocaleString('en-US', { month: 'short' });
            return `${day} ${month}`;
        }

        let selectedCities = JSON.parse(localStorage.getItem('globalSync_v2')) || [
            { name: 'Mumbai', timezone: 'Asia/Kolkata', start: 9, end: 18, isHome: true },
            { name: 'London', timezone: 'Europe/London', start: 9, end: 18, isHome: false },
            { name: 'New York', timezone: 'America/New_York', start: 9, end: 18, isHome: false }
        ];

        const citiesList = document.getElementById('citiesList');
        const citySearch = document.getElementById('citySearch');
        const searchResults = document.getElementById('searchResults');
        const commonTimeOverlay = document.getElementById('commonTimeOverlay');
        const goldenHourNotice = document.getElementById('goldenHourNotice');
        const homeNotice = document.getElementById('homeNotice');
        const scrubber = document.getElementById('scrubber');
        const suggestionsPanel = document.getElementById('suggestionsPanel');

        let isFutureMode = false;
        let meetingDuration = 1;

        function updateDuration(val) { meetingDuration = parseFloat(val); render(); }

        function toggleFuture() {
            isFutureMode = !isFutureMode;
            const btn = document.getElementById('futureToggle');
            const dot = document.getElementById('futureStatusDot');
            btn.innerText = isFutureMode ? 'Checking Next Week' : 'Verify DST Shift';
            btn.prepend(dot);
            render();
        }

        function saveState() { localStorage.setItem('globalSync_v2', JSON.stringify(selectedCities)); }

        function formatTime(totalMinutes) {
            const h = Math.floor((totalMinutes / 60 + 24) % 24), m = Math.floor(Math.abs(totalMinutes % 60));
            return `${h % 12 || 12}:${m.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
        }

        function updateBusinessHours(index, field, value) { selectedCities[index][field] = parseInt(value); render(); }
        function setHome(index) { selectedCities.forEach((c, i) => c.isHome = (i === index)); render(); }
        function removeCity(index) { selectedCities.splice(index, 1); render(); }

        function suggestMeetings() {
            if (selectedCities.length === 0) return;
            const baseDate = isFutureMode ? new Date(Date.now() + 7 * 24 * 36e5) : new Date();
            
            // Tiered Suggestion Engine
            let bestSlots = [];
            for (let hUTC = 0; hUTC < 24; hUTC += 0.5) {
                let score = 0;
                let isValid = true;
                
                selectedCities.forEach(city => {
                    const offset = getTimezoneOffset(city.timezone, baseDate);
                    const localH = (hUTC + offset + 24) % 24;
                    const endLocalH = (localH + meetingDuration) % 24;
                    
                    // Forbidden Zone (Hard Limit: 11pm - 7am)
                    if ((localH >= 23 || localH < 7) || (endLocalH > 23 || endLocalH < 7)) isValid = false;
                    
                    // Preferred Zone (9am - 9pm)
                    if (city.isHome) {
                        if (localH >= 8 && localH < 22) score += 2; // Home base flexibility
                    } else {
                        if (localH >= 9 && localH < 21) score += 1;
                    }
                });
                
                if (isValid) bestSlots.push({ hUTC, score });
            }
            
            bestSlots.sort((a, b) => b.score - a.score);
            const picked = bestSlots.slice(0, 3);
            
            suggestionsPanel.innerHTML = '';
            if (picked.length > 0) {
                picked.forEach((slot, i) => {
                    const card = document.createElement('div');
                    card.className = `suggestion-card p-4 rounded-xl cursor-pointer border border-white/5`;
                    let breakdown = selectedCities.map(c => `<div class="flex justify-between text-[9px] font-bold"><span>${c.name}</span><span class="text-blue-400">${formatTime((slot.hUTC + getTimezoneOffset(c.timezone, baseDate)) * 60)}</span></div>`).join('');
                    card.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="text-[9px] text-emerald-400 font-black uppercase">Slot #${i+1}</span><button onclick="event.stopPropagation(); openOutlook(${slot.hUTC})" class="text-blue-500 hover:text-white"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg></button></div><div class="space-y-0.5">${breakdown}</div>`;
                    card.onclick = () => moveScrubber((slot.hUTC / 24) * 100);
                    suggestionsPanel.appendChild(card);
                });
            } else {
                suggestionsPanel.innerHTML = '<div class="col-span-3 text-center py-6 glass text-red-400 text-[10px] font-black uppercase">No slots found within safe guardrails (7am - 11pm)</div>';
            }
            suggestionsPanel.classList.remove('hidden');
        }

        function moveScrubber(percent) {
            scrubber.style.left = `calc(${percent}% + 18rem)`;
            updateScrubberLabels(percent);
            scrubber.classList.remove('hidden');
            document.querySelectorAll('.scrubber-label').forEach(l => l.classList.remove('hidden'));
        }

        function updateScrubberLabels(percent) {
            const baseDate = isFutureMode ? new Date(Date.now() + 7 * 24 * 36e5) : new Date();
            const utcHours = (percent / 100) * 24;
            selectedCities.forEach((city, index) => {
                const offset = getTimezoneOffset(city.timezone, baseDate);
                const localDateTime = new Date(baseDate.getTime());
                localDateTime.setUTCHours(0, 0, 0, 0);
                localDateTime.setTime(localDateTime.getTime() + (utcHours + offset) * 36e5);
                const label = document.getElementById(`scrubberLabel-${index}`);
                const dateLabel = document.getElementById(`dateLabel-${index}`);
                if (label) {
                    label.innerText = formatTime((utcHours + offset) * 60);
                    label.style.left = `${percent}%`;
                    label.style.transform = percent > 85 ? 'translateX(-100%)' : (percent < 15 ? 'translateX(0%)' : 'translateX(-50%)');
                }
                if (dateLabel) dateLabel.innerText = formatDate(localDateTime);
            });
        }

        function openOutlook(startUTC) {
            const baseDate = isFutureMode ? new Date(Date.now() + 7 * 24 * 36e5) : new Date();
            const start = new Date(baseDate); start.setUTCHours(Math.floor(startUTC), (startUTC % 1) * 60, 0, 0);
            const end = new Date(start.getTime() + meetingDuration * 36e5);
            window.open(`https://outlook.office.com/calendar/0/deeplink/compose?subject=Meeting&startdt=${start.toISOString().replace(/-|:|\.\d+/g, '')}&enddt=${end.toISOString().replace(/-|:|\.\d+/g, '')}`, '_blank');
        }

        function render() {
            citiesList.querySelectorAll('.city-row').forEach(row => row.remove());
            saveState();
            const baseDate = isFutureMode ? new Date(Date.now() + 7 * 24 * 36e5) : new Date();
            let commonStartUTC = -Infinity, commonEndUTC = Infinity;
            selectedCities.forEach(city => {
                const offset = getTimezoneOffset(city.timezone, baseDate);
                commonStartUTC = Math.max(commonStartUTC, city.start - offset);
                commonEndUTC = Math.min(commonEndUTC, city.end - offset);
                city.dstInfo = isDSTImminent(city.timezone, 7, baseDate);
            });
            const hasCommon = commonStartUTC < commonEndUTC;
            goldenHourNotice.classList.toggle('hidden', !hasCommon);
            homeNotice.classList.toggle('hidden', false); // Always show status of guardrails

            selectedCities.forEach((city, index) => {
                const row = document.createElement('div');
                row.className = `city-row flex items-center group py-4 relative border-b border-white/5 last:border-0 ${city.isHome ? 'home-city-row' : ''}`;
                const offset = getTimezoneOffset(city.timezone, baseDate);
                const localTimeStr = baseDate.toLocaleTimeString('en-US', { timeZone: city.timezone, hour: '2-digit', minute: '2-digit', hour12: true });
                let bStart = (city.start - offset + 24) % 24, bEnd = (city.end - offset + 24) % 24;
                // Forbidden zone (11pm - 7am local)
                let fStart = (23 - offset + 24) % 24, fEnd = (7 - offset + 24) % 24;

                row.innerHTML = `
                    <div class="w-72 shrink-0 pr-8 pl-4 flex flex-col justify-center sticky left-0 z-20 bg-[#020617] group-hover:bg-[#0a0f1e] transition-colors">
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="flex items-center gap-2 overflow-hidden">
                                ${city.isHome ? '<svg xmlns="http://www.w3.org/2000/svg" class="text-amber-500 shrink-0" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="m12 3 1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>' : ''}
                                <span class="font-bold text-slate-100 truncate text-lg tracking-tight">${city.name}</span>
                            </div>
                            ${city.dstInfo && city.dstInfo.imminent ? '<div class="px-1.5 py-0.5 rounded bg-amber-500/10 border border-amber-500/20 text-amber-500 animate-pulse text-[8px] font-black">DST</div>' : ''}
                        </div>
                        <div class="flex items-center gap-3 mb-2.5">
                            <span class="text-[9px] font-mono text-slate-500 uppercase tracking-tighter">UTC${offset >= 0 ? '+' : ''}${offset}</span>
                            <span class="text-[10px] font-black text-blue-400 uppercase tracking-wider">${localTimeStr}</span>
                            <span id="dateLabel-${index}" class="text-[9px] font-bold text-slate-600 uppercase">${formatDate(new Date(baseDate.toLocaleString('en-US', { timeZone: city.timezone })))}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1.5">
                                <select onchange="updateBusinessHours(${index}, 'start', this.value)" class="bg-slate-800/40 text-[9px] text-emerald-400 font-black border border-emerald-500/10 rounded px-1.5 py-1 outline-none cursor-pointer">
                                    ${Array.from({length: 24}).map((_, i) => `<option value="${i}" ${city.start === i ? 'selected' : ''} class="bg-slate-900">${i % 12 || 12}${i < 12 ? 'am' : 'pm'}</option>`).join('')}
                                </select>
                                <span class="text-slate-700 font-bold">-</span>
                                <select onchange="updateBusinessHours(${index}, 'end', this.value)" class="bg-slate-800/40 text-[9px] text-emerald-400 font-black border border-emerald-500/10 rounded px-1.5 py-1 outline-none cursor-pointer">
                                    ${Array.from({length: 24}).map((_, i) => `<option value="${i}" ${city.end === i ? 'selected' : ''} class="bg-slate-900">${i % 12 || 12}${i < 12 ? 'am' : 'pm'}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex gap-1 action-btns">
                                <button onclick="setHome(${index})" class="text-slate-600 hover:text-amber-400 p-1 transition-colors"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></button>
                                <button onclick="removeCity(${index})" class="text-slate-600 hover:text-red-400 p-1 transition-colors"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 h-20 relative group/grid pr-4">
                        <div id="scrubberLabel-${index}" class="scrubber-label hidden top-[-24px]"></div>
                        <div class="h-full glass relative overflow-hidden bg-slate-950/20 border-white/5 shadow-inner">
                            <div class="absolute inset-x-0 bottom-1.5 flex justify-between px-3 text-[8px] font-bold text-slate-700 uppercase tracking-tighter z-0 pointer-events-none">
                                ${Array.from({length: 13}).map((_, i) => { const localH = (i * 2 + offset + 24) % 24; return `<span>${Math.floor(localH % 12 || 12)}${localH < 12 ? 'a' : 'p'}</span>`; }).join('')}
                            </div>
                            <!-- Forbidden Overlays -->
                            <div class="forbidden-overlay" style="left: ${(fStart/24)*100}%; width: ${((24-fStart)/24)*100}%"></div>
                            <div class="forbidden-overlay" style="left: 0; width: ${(fEnd/24)*100}%"></div>
                            
                            ${Array.from({length: 25}).map((_, i) => `<div class="hour-marker" style="left: ${(i/24)*100}%"></div>`).join('')}
                            ${bStart < bEnd ? `<div class="absolute top-0 bottom-0 business-hours" style="left: ${(bStart/24)*100}%; width: ${((bEnd-bStart)/24)*100}%"></div>` : `<div class="absolute top-0 bottom-0 business-hours" style="left: ${(bStart/24)*100}%; width: ${((24-bStart)/24)*100}%"></div><div class="absolute top-0 bottom-0 business-hours" style="left: 0; width: ${(bEnd/24)*100}%"></div>`}
                            <div class="current-time-marker" style="left: ${(new Date().getUTCHours() * 60 + new Date().getUTCMinutes()) / 1440 * 100}%"></div>
                        </div>
                    </div>`;
                citiesList.appendChild(row);
            });
            if (hasCommon) {
                let start = (commonStartUTC % 24 + 24) % 24, end = (commonEndUTC % 24 + 24) % 24;
                if (start < end) { commonTimeOverlay.classList.remove('hidden'); commonTimeOverlay.style.left = `calc(${(start/24)*100}% + 18rem)`; commonTimeOverlay.style.width = `${((end-start)/24)*100}%`; }
            } else commonTimeOverlay.classList.add('hidden');
        }

        citySearch.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase().trim();
            if (val.length < 2) { searchResults.classList.add('hidden'); return; }
            const matches = CITY_DATA.filter(c => c.city.toLowerCase().includes(val) || c.region.toLowerCase().includes(val)).slice(0, 10);
            if (matches.length > 0) {
                searchResults.innerHTML = matches.map(m => `<div class="px-4 py-2 hover:bg-blue-500/10 cursor-pointer text-[10px] flex justify-between" onclick="addCity('${m.city}', '${m.timezone}')"><span>${m.city}</span><span class="text-slate-500">${m.region}</span></div>`).join('');
                searchResults.classList.remove('hidden');
            }
        });

        citiesList.addEventListener('mousemove', (e) => {
            const rect = citiesList.getBoundingClientRect();
            const offsetX = 18 * 16, x = e.clientX - rect.left - offsetX, gridWidth = rect.width - offsetX;
            if (x >= 0 && x <= gridWidth) {
                const snappedPercent = Math.round(((x / gridWidth) * 1440) / 15) * 15 / 1440 * 100;
                scrubber.style.left = `calc(${snappedPercent}% + 18rem)`;
                updateScrubberLabels(snappedPercent);
                scrubber.classList.remove('hidden');
                document.querySelectorAll('.scrubber-label').forEach(l => l.classList.remove('hidden'));
            } else { scrubber.classList.add('hidden'); document.querySelectorAll('.scrubber-label').forEach(l => l.classList.add('hidden')); }
        });

        citiesList.addEventListener('mouseleave', () => { scrubber.classList.add('hidden'); document.querySelectorAll('.scrubber-label').forEach(l => l.classList.add('hidden')); });

        window.addCity = (name, timezone) => {
            if (!selectedCities.find(c => c.timezone === timezone)) selectedCities.push({ name, timezone, start: 9, end: 18, isHome: false });
            citySearch.value = ''; searchResults.classList.add('hidden'); render();
        };

        document.addEventListener('click', (e) => { if (!citySearch.contains(e.target)) searchResults.classList.add('hidden'); });
        render();
        setInterval(render, 60000);
    </script>
</body>
</html>
