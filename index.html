<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Sync - Timezone Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --bg-deep: #020617;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
            --accent-home: #f59e0b;
            --left-col-width: 14rem;
            --row-height: 4rem;
            --block-width: 44px;
        }

        body {
            background-color: var(--bg-deep);
            background-image:
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            min-height: 100vh;
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .city-row {
            height: var(--row-height);
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            align-items: center;
            width: fit-content;
        }
        .city-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .home-city-row {
            border-left: 4px solid var(--accent-home) !important;
            background: rgba(245, 158, 11, 0.03);
        }

        .timeline-header {
            height: 3.5rem;
            position: sticky;
            top: 0;
            z-index: 60;
            background: #020617;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: stretch;
            width: fit-content;
        }

        .hour-block {
            width: var(--block-width);
            height: 100%;
            border-right: 1px solid rgba(255, 255, 255, 0.03);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.2);
            position: relative;
            transition: background 0.1s;
        }

        /* Grid wrapper so header and rows share an identical column layout */
        .hours-grid {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: var(--block-width);
            align-items: center;
            height: var(--row-height);
            column-gap: 0;
        }

        .block-night { background: rgba(8, 12, 30, 0.7); }
        .block-day { background: rgba(255, 255, 255, 0.02); }
        .block-business { background: rgba(16, 185, 129, 0.2); color: rgba(16, 185, 129, 0.5); }
        .block-home { border-top: 2px solid rgba(245, 158, 11, 0.3); }
        /* Right-edge marker on the last business-hour block per city */
        .block-eod {
            border-right: 3px solid rgba(16, 185, 129, 0.7);
            box-shadow: inset -4px 0 10px rgba(16, 185, 129, 0.15);
        }
        .block-day-boundary {
            border-left: 2px solid rgba(255, 255, 255, 0.22);
            position: relative;
            box-shadow: inset 2px 0 8px rgba(0,0,0,0.18);
        }
        /* Day separator glow line in timeline header */
        .hour-block.block-day-boundary {
            border-left: 2px solid rgba(255, 255, 255, 0.3);
        }

        .timeline-header-right {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .day-band {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.45);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            border-right: 2px solid rgba(255, 255, 255, 0.12);
            height: 1.25rem;
        }
        .day-band:last-child { border-right: none; }
        .day-band-even { background: rgba(255, 255, 255, 0.025); }

        .now-marker {
            position: absolute;
            top: 0; bottom: 0;
            width: 2px;
            background: #10b981;
            z-index: 90;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }

        /* DST transition vertical marker */
        .dst-marker {
            position: absolute;
            top: 0; bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #fbbf24, rgba(251,191,36,0.4));
            z-index: 85;
            pointer-events: none;
            box-shadow: 0 0 14px rgba(251, 191, 36, 0.8), 0 0 4px rgba(251, 191, 36, 0.5);
        }
        /* Floating pill label above the DST marker */
        .dst-marker-label {
            position: absolute;
            top: 4px;
            transform: translateX(-50%);
            background: rgba(251, 191, 36, 0.18);
            border: 1px solid rgba(251, 191, 36, 0.6);
            color: #fbbf24;
            font-size: 7px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 3px 6px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 86;
            pointer-events: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5), 0 0 8px rgba(251,191,36,0.25);
        }

        /* Day boundary date label — pinned to top so it never overlaps the hour text */
        .date-marker-inline {
            position: absolute;
            left: 4px;
            top: 3px;
            transform: none;
            font-size: 7px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.65);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 2px 4px;
            border-radius: 3px;
            z-index: 10;
            white-space: nowrap;
        }

        /* Hour label styles for timeline header */
        .hour-label-major {
            position: absolute;
            bottom: 3px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 9px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.35);
            font-family: 'JetBrains Mono', monospace;
        }

        .hour-label-day {
            position: absolute;
            top: 3px;
            left: 3px;
            font-size: 7px;
            font-weight: 900;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1;
        }

        .scrubber-line {
            width: var(--scrubber-width, 44px);
            background: rgba(59, 130, 246, 0.1);
            border-left: 2px solid var(--accent-blue);
            border-right: 2px solid var(--accent-blue);
            height: 100%;
            position: absolute;
            z-index: 100;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        /* Floating scrubber tooltip card */
        .scrubber-tooltip {
            position: fixed;
            display: none;
            background: rgba(2, 6, 23, 0.97);
            border: 1px solid rgba(59, 130, 246, 0.45);
            border-radius: 10px;
            z-index: 9000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 16px 48px rgba(0,0,0,0.7), 0 0 0 1px rgba(59,130,246,0.08);
            overflow: hidden;
            min-width: 190px;
        }
        .scrubber-tooltip-header {
            background: rgba(59, 130, 246, 0.12);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            padding: 7px 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 800;
            color: #60a5fa;
            letter-spacing: 0.04em;
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        .scrubber-tooltip-header small {
            font-size: 9px;
            font-weight: 500;
            opacity: 0.55;
            letter-spacing: 0.08em;
        }
        .scrubber-tooltip-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .scrubber-tooltip-row:last-child { border-bottom: none; }
        .scrubber-tooltip-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .scrubber-tooltip-city {
            font-size: 10px;
            font-weight: 600;
            color: #94a3b8;
            flex: 1;
        }
        .scrubber-tooltip-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 800;
            color: #e2e8f0;
        }

        .date-btn {
            @apply flex flex-col items-center justify-center transition-all duration-200;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            flex-shrink: 0;
        }
        .date-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .date-btn.active {
            background: var(--accent-blue);
            border-color: transparent;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.35);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        .common-time-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            background: rgba(59, 130, 246, 0.08);
            border-left: 1px dashed rgba(59, 130, 246, 0.4);
            border-right: 1px dashed rgba(59, 130, 246, 0.4);
            pointer-events: none;
            z-index: 10;
        }

        /* Unified button system */
        .control-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 0.5rem;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 0.5rem 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
            border: none;
        }
        .btn-ghost {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: #94a3b8;
            backdrop-filter: blur(12px);
        }
        .btn-ghost:hover {
            color: #60a5fa;
            border-color: rgba(96, 165, 250, 0.3);
        }
        .btn-primary {
            background: #059669;
            border: 1px solid transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        .btn-primary:hover {
            background: #10b981;
        }

        /* DST badge */
        .dst-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            color: #fbbf24;
            border-radius: 4px;
            font-size: 7px;
            font-weight: 800;
            padding: 1px 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1.4;
        }

        /* Suggestion card */
        .suggestion-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .suggestion-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* Toast error */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-error {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 12px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            animation: slideInRight 0.3s ease forwards;
        }
    </style>
</head>
<body class="font-sans antialiased overflow-x-hidden">
    <div class="max-w-[1600px] mx-auto p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <header class="relative z-[100] flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-8">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-emerald-500 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Global Sync</h1>
                    <p class="text-[9px] text-slate-500 font-medium tracking-widest uppercase mt-0.5">Coordinate across timezones</p>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <button onclick="toggleClockFormat()" class="control-btn btn-ghost">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="clockFormatText">12H</span>
                </button>
                <div class="control-btn btn-ghost" style="gap: 0.375rem; padding-right: 0.5rem;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                    <span class="text-slate-500">Duration</span>
                    <select id="durationSelect" onchange="updateDuration(this.value)" class="bg-transparent text-blue-400 focus:outline-none cursor-pointer font-bold text-[10px]">
                        <option value="0.5">30 min</option>
                        <option value="1" selected>1 hour</option>
                        <option value="2">2 hours</option>
                    </select>
                </div>
                <div class="relative group">
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" style="color:#94a3b8; z-index:10;" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></svg>
                        <input type="text" id="citySearch" autocomplete="off" placeholder="Add City..." class="glass pl-9 pr-4 py-2 rounded-lg text-sm w-48 focus:w-64 transition-all outline-none border-white/5 focus:border-blue-500/50">
                    </div>
                    <div id="searchResults" class="absolute top-full left-0 right-0 mt-2 glass rounded-xl z-[200] hidden max-h-60 overflow-y-auto shadow-2xl bg-slate-900/95"></div>
                </div>
                <button onclick="suggestMeetings()" class="control-btn btn-primary">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>
                    Find Slots
                </button>
            </div>
        </header>

        <!-- Suggestions -->
        <div id="suggestionsPanel" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>

        <!-- Date Selection -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
            <div class="flex items-center gap-4">
                <div class="flex flex-col gap-1">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest ml-1">Select Date</span>
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" style="color:#94a3b8; z-index:10;" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        <input type="text" id="calendarPicker" placeholder="Select date..."
                          class="glass bg-transparent pl-9 pr-4 h-14 rounded-xl text-[11px] font-bold text-blue-400 outline-none cursor-pointer hover:border-blue-500/30 transition-colors" readonly>
                    </div>
                </div>
                <div class="h-10 w-px bg-white/5 mx-2"></div>
                <div id="dateStrip" class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar"></div>
            </div>

            <div class="flex items-center gap-4">
                <div id="goldenHourNotice" class="hidden px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[9px] font-black uppercase tracking-widest flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse"></span>
                    Overlapping Hours
                </div>
            </div>
        </div>

        <!-- Timeline Container -->
        <div class="glass rounded-2xl overflow-hidden shadow-2xl flex flex-col">
            <div class="timeline-header">
                <div class="w-[14rem] shrink-0 border-r border-white/10 bg-slate-950 flex flex-col justify-between py-1.5 px-4 sticky left-0 z-[70]">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Locations</span>
                    <span class="text-[8px] text-amber-600/60 font-bold tracking-widest">Home Base →</span>
                </div>
                <div class="timeline-header-right">
                    <div id="dayLabelsRow" class="flex"></div>
                    <div class="flex flex-1" id="timelineLabels"></div>
                </div>
            </div>

            <div class="overflow-x-auto overflow-y-auto custom-scrollbar" id="citiesScrollContainer" style="max-height: 60vh;">
                <div class="relative w-max" id="citiesList">
                    <div id="commonTimeOverlay" class="common-time-overlay hidden"></div>
                    <div id="scrubber" class="absolute top-0 bottom-0 hidden pointer-events-none z-[100]">
                        <div class="scrubber-line"></div>
                    </div>
                    <div id="nowMarker" class="now-marker hidden"></div>
                    <div id="dstMarkersContainer"></div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="mt-6 flex flex-wrap gap-6 opacity-50">
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-emerald-500/20 border border-emerald-500/40"></div><span class="text-[9px] font-bold uppercase tracking-widest">Working Hours</span></div>
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-slate-800 border border-white/5"></div><span class="text-[9px] font-bold uppercase tracking-widest">Personal Time</span></div>
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded border-l-4 border-amber-500 bg-amber-500/10"></div><span class="text-[9px] font-bold uppercase tracking-widest">Home Base</span></div>
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded border border-dashed border-blue-500/60 bg-blue-500/10"></div><span class="text-[9px] font-bold uppercase tracking-widest">Overlap Window</span></div>
            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded" style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.6);box-shadow:0 0 6px rgba(251,191,36,0.4);"></div><span class="text-[9px] font-bold uppercase tracking-widest">DST Change</span></div>
        </div>
    </div>

    <div id="scrubberTooltip" class="scrubber-tooltip"></div>

    <script src="./src/utils/dst.js"></script>
    <script>
        const utils = {
            isDSTImminent: window.isDSTImminent,
            getTimezoneOffset: window.getTimezoneOffset,
            formatDate: window.formatDate,
            formatTime: window.formatTime,
            formatHourLabel: window.formatHourLabel
        };

        let selectedCities = JSON.parse(localStorage.getItem('globalSync_v3')) || [
            { name: 'Mumbai', timezone: 'Asia/Kolkata', start: 9, end: 18, isHome: true },
            { name: 'London', timezone: 'Europe/London', start: 9, end: 18, isHome: false },
            { name: 'New York', timezone: 'America/New_York', start: 9, end: 18, isHome: false }
        ];

        const TOTAL_HOURS = 72;
        const BLOCK_WIDTH = 44;
        const OFFSET_X = 14 * 16; // 14rem = 224px

        const citiesList = document.getElementById('citiesList');
        const timelineLabels = document.getElementById('timelineLabels');
        const scrubber = document.getElementById('scrubber');
        const suggestionsPanel = document.getElementById('suggestionsPanel');
        const dateStrip = document.getElementById('dateStrip');
        const calendarPicker = document.getElementById('calendarPicker');
        const commonTimeOverlay = document.getElementById('commonTimeOverlay');
        const citySearch = document.getElementById('citySearch');
        const searchResults = document.getElementById('searchResults');
        const goldenHourNotice = document.getElementById('goldenHourNotice');
        const scrubberTooltip = document.getElementById('scrubberTooltip');
        const dayLabelsRow = document.getElementById('dayLabelsRow');
        const nowMarker = document.getElementById('nowMarker');
        const dstMarkersContainer = document.getElementById('dstMarkersContainer');

        let is24Hour = JSON.parse(localStorage.getItem('globalSync_is24h')) || false;
        let meetingDuration = 1;
        let baseDate = new Date();
        baseDate.setHours(0,0,0,0);
        let fpInstance;

        function toggleClockFormat() {
            is24Hour = !is24Hour;
            localStorage.setItem('globalSync_is24h', JSON.stringify(is24Hour));
            document.getElementById('clockFormatText').innerText = is24Hour ? '24H' : '12H';
            render();
        }
        window.toggleClockFormat = toggleClockFormat;

        function updateDuration(val) { meetingDuration = parseFloat(val); render(); }
        window.updateDuration = updateDuration;

        function setDate(dateStr) {
            baseDate = new Date(dateStr);
            if (isNaN(baseDate.getTime())) baseDate = new Date();
            baseDate.setHours(0,0,0,0);
            render();
        }
        window.setDate = setDate;

        function renderDateStrip() {
            dateStrip.innerHTML = '';
            // Anchor strip to baseDate (selected date), not always today
            const anchor = new Date(baseDate); anchor.setHours(0,0,0,0);
            for (let i = 0; i < 7; i++) {
                const d = new Date(anchor); d.setDate(anchor.getDate() + i);
                const btn = document.createElement('button');
                const isActive = i === 0; // baseDate is always the first/highlighted button
                btn.className = `date-btn ${isActive ? 'active' : ''}`;
                btn.innerHTML = `<span class="text-[10px] font-black uppercase opacity-60">${d.toLocaleDateString('en-US', { weekday: 'short' })}</span><span class="text-lg font-black">${d.getDate()}</span>`;
                btn.onclick = () => { baseDate = new Date(d); render(); };
                dateStrip.appendChild(btn);
            }
            if (fpInstance) fpInstance.setDate(baseDate, false);
            else calendarPicker.value = baseDate.toISOString().split('T')[0];
        }

        function renderDayBands() {
            dayLabelsRow.innerHTML = '';
            const homeCity = selectedCities.find(c => c.isHome) || selectedCities[0];
            const homeOffset = homeCity ? utils.getTimezoneOffset(homeCity.timezone, baseDate) : 0;

            // The timeline starts at home city's midnight.
            // For the header, render 3 day-bands of 24h each, labeled by home city date.
            for (let i = 0; i < 3; i++) {
                // Hour 0 on the timeline = home city midnight on baseDate.
                // Day i starts at timeline hour i*24.
                // That corresponds to UTC hour: i*24 - homeOffset.
                const utcMsForDayStart = baseDate.getTime() + (i * 24 - homeOffset) * 3600000;
                const localDateStr = new Date(utcMsForDayStart + homeOffset * 3600000);
                const label = localDateStr.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const band = document.createElement('div');
                band.className = `day-band${i % 2 === 1 ? ' day-band-even' : ''}`;
                band.style.width = `${24 * BLOCK_WIDTH}px`;
                band.textContent = label.toUpperCase();
                dayLabelsRow.appendChild(band);
            }
        }

        function renderTimelineHeader() {
            renderDayBands();
            timelineLabels.className = 'hours-grid';
            timelineLabels.style.height = '2.25rem';
            timelineLabels.innerHTML = '';
            // Hour labels are in home-city local time (hour 0 = home midnight).
            for (let i = 0; i < TOTAL_HOURS; i++) {
                const label = document.createElement('div');
                const h = i % 24;
                const isDayBoundary = h === 0 && i > 0;
                label.className = `hour-block${isDayBoundary ? ' block-day-boundary' : ''}`;

                let innerHtml = '';
                if (h % 3 === 0) {
                    innerHtml += `<span class="hour-label-major">${utils.formatHourLabel(h, is24Hour).replace(' ', '')}</span>`;
                }
                label.innerHTML = innerHtml;
                timelineLabels.appendChild(label);
            }
        }

        window.updateBusinessHours = (index, field, value) => { selectedCities[index][field] = parseInt(value); render(); };
        window.setHome = (index) => { selectedCities.forEach((c, i) => c.isHome = (i === index)); render(); };
        window.removeCity = (index) => { selectedCities.splice(index, 1); render(); };

        function openOutlook(startUTC) {
            const start = new Date(baseDate);
            start.setUTCHours(Math.floor(startUTC), (startUTC % 1) * 60, 0, 0);
            const end = new Date(start.getTime() + meetingDuration * 36e5);
            const url = `https://outlook.office.com/calendar/0/deeplink/compose?subject=Meeting&startdt=${start.toISOString().replace(/-|:|\.\d+/g, '')}&enddt=${end.toISOString().replace(/-|:|\.\d+/g, '')}`;
            window.open(url, '_blank');
        }
        window.openOutlook = openOutlook;

        function suggestMeetings() {
            if (selectedCities.length === 0) return;
            let bestSlots = [];
            for (let hUTC = 0; hUTC < 24; hUTC += 0.5) {
                let score = 0, isValid = true;
                selectedCities.forEach(city => {
                    const offset = utils.getTimezoneOffset(city.timezone, baseDate);
                    const localH = (hUTC + offset + 24) % 24;
                    if ((localH >= 23 || localH < 7)) isValid = false;
                    if (city.isHome) { if (localH >= 8 && localH < 22) score += 2; } else { if (localH >= 9 && localH < 21) score += 1; }
                });
                if (isValid) bestSlots.push({ hUTC, score });
            }
            bestSlots.sort((a, b) => b.score - a.score);
            const picked = bestSlots.slice(0, 3);
            suggestionsPanel.innerHTML = '';
            picked.forEach((slot, i) => {
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                let breakdown = selectedCities.map(c => {
                    const dot = c.isHome
                        ? '<span class="w-1.5 h-1.5 rounded-full bg-amber-400 flex-shrink-0 mt-0.5"></span>'
                        : '<span class="w-1.5 h-1.5 rounded-full bg-slate-500 flex-shrink-0 mt-0.5"></span>';
                    const time = utils.formatTime((slot.hUTC + utils.getTimezoneOffset(c.timezone, baseDate)) * 60, is24Hour);
                    return `<div class="flex items-center justify-between gap-2"><div class="flex items-center gap-1.5">${dot}<span class="text-[10px] text-slate-300">${c.name}</span></div><span class="text-[11px] font-black text-blue-400 font-mono">${time}</span></div>`;
                }).join('');
                const homeCity2 = selectedCities.find(c => c.isHome) || selectedCities[0];
                const homeOff2 = homeCity2 ? utils.getTimezoneOffset(homeCity2.timezone, baseDate) : 0;
                const homeSlotTime = utils.formatTime(((slot.hUTC + homeOff2) % 24 * 60 + 24 * 60) % (24 * 60), is24Hour);
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[9px] text-emerald-400 font-black uppercase tracking-widest">Slot #${i+1}</span>
                        <span class="text-[10px] font-mono text-amber-400">${homeSlotTime} ${homeCity2 ? homeCity2.name : ''}</span>
                    </div>
                    <div class="space-y-1.5 mb-3">${breakdown}</div>
                    <button onclick="event.stopPropagation(); window.openOutlook(${slot.hUTC})" class="w-full flex items-center justify-center gap-2 py-1.5 rounded-lg border border-blue-500/30 text-blue-400 text-[9px] font-black uppercase tracking-widest hover:bg-blue-500/10 transition-colors">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                        Calendar
                    </button>`;
                // Convert UTC slot hour to timeline hour (home-anchored)
                const slotTimelineH = slot.hUTC + homeOff2;
                card.onclick = () => moveScrubber((slotTimelineH / TOTAL_HOURS) * 100);
                suggestionsPanel.appendChild(card);
            });
            suggestionsPanel.classList.toggle('hidden', picked.length === 0);
        }
        window.suggestMeetings = suggestMeetings;

        function moveScrubber(percent) {
            const gridWidth = TOTAL_HOURS * BLOCK_WIDTH;
            scrubber.style.left = `${(percent / 100) * gridWidth + OFFSET_X}px`;
            scrubber.classList.remove('hidden');
        }

        function showScrubberTooltip(percent, mouseX, mouseY) {
            // Timeline hour 0 = home city midnight. Convert to UTC hours.
            const homeCity = selectedCities.find(c => c.isHome) || selectedCities[0];
            const homeOff = homeCity ? utils.getTimezoneOffset(homeCity.timezone, baseDate) : 0;
            const timelineHour = (percent / 100) * TOTAL_HOURS;
            // UTC hour = timelineHour - homeOff
            const utcHoursTotal = timelineHour - homeOff;

            let rowsHtml = selectedCities.map(city => {
                const offset = utils.getTimezoneOffset(city.timezone, baseDate);
                const localTime = utils.formatTime(((utcHoursTotal + offset) % 24 * 60 + 24 * 60) % (24 * 60), is24Hour);
                const dotColor = city.isHome ? '#f59e0b' : '#475569';
                return `<div class="scrubber-tooltip-row">
                    <span class="scrubber-tooltip-dot" style="background:${dotColor}"></span>
                    <span class="scrubber-tooltip-city">${city.name}</span>
                    <span class="scrubber-tooltip-time">${localTime}</span>
                </div>`;
            }).join('');

            // Header shows home city time (no UTC)
            const homeTime = homeCity
                ? utils.formatTime(((utcHoursTotal + homeOff) % 24 * 60 + 24 * 60) % (24 * 60), is24Hour)
                : utils.formatTime(((utcHoursTotal) % 24 * 60 + 24 * 60) % (24 * 60), is24Hour);

            scrubberTooltip.innerHTML = `<div class="scrubber-tooltip-header">${homeTime}<small>${homeCity ? homeCity.name : ''}</small></div>${rowsHtml}`;
            scrubberTooltip.style.display = 'block';

            // Position near cursor, clamped to viewport
            const ttW = scrubberTooltip.offsetWidth || 200;
            const ttH = scrubberTooltip.offsetHeight || 120;
            let left = mouseX + 18;
            let top = mouseY - ttH - 12;
            if (left + ttW > window.innerWidth - 8) left = mouseX - ttW - 12;
            if (top < 8) top = mouseY + 18;
            scrubberTooltip.style.left = `${left}px`;
            scrubberTooltip.style.top = `${top}px`;
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-error';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function render() {
            citiesList.querySelectorAll('.city-row').forEach(row => row.remove());
            localStorage.setItem('globalSync_v3', JSON.stringify(selectedCities));
            renderDateStrip();
            renderTimelineHeader();

            let commonStartUTC = -Infinity, commonEndUTC = Infinity;
            selectedCities.forEach(city => {
                const offset = utils.getTimezoneOffset(city.timezone, baseDate);
                commonStartUTC = Math.max(commonStartUTC, city.start - offset);
                commonEndUTC = Math.min(commonEndUTC, city.end - offset);
            });
            const hasCommon = commonStartUTC < commonEndUTC;
            goldenHourNotice.classList.toggle('hidden', !hasCommon);

            const homeCity = selectedCities.find(c => c.isHome);
            const homeOffset = homeCity ? utils.getTimezoneOffset(homeCity.timezone, baseDate) : 0;
            function fmtRel(h) {
                if (h === 0) return 'same time';
                const sign = h > 0 ? '+' : '−';
                const absH = Math.abs(h);
                const hrs = Math.floor(absH);
                const mins = Math.round((absH - hrs) * 60);
                return mins ? `${sign}${hrs}h ${mins}m` : `${sign}${hrs}h`;
            }

            selectedCities.forEach((city, index) => {
                const row = document.createElement('div');
                row.className = `city-row group relative ${city.isHome ? 'home-city-row' : ''}`;
                const offset = utils.getTimezoneOffset(city.timezone, baseDate);
                const now = new Date();
                const localTimeStr = now.toLocaleTimeString('en-US', { timeZone: city.timezone, hour: '2-digit', minute: '2-digit', hour12: !is24Hour });

                const relOffset = offset - homeOffset;
                const offsetLabel = city.isHome ? '' : `<span class="text-[8px] font-bold text-slate-500 uppercase tracking-widest">${fmtRel(relOffset)} vs home</span>`;

                const dstInfo = utils.isDSTImminent(city.timezone, 7, baseDate);
                const dstBadge = dstInfo.imminent
                    ? `<span class="dst-badge">${dstInfo.daysUntil === 1 ? 'DST tomorrow' : `DST in ${dstInfo.daysUntil}d`}</span>`
                    : '';
                const homeBadge = city.isHome
                    ? `<span class="dst-badge" style="background:rgba(245,158,11,0.1);border-color:rgba(245,158,11,0.25);color:#f59e0b;">Home</span>`
                    : '';

                let hourBlocksHtml = '';
                // hTotal=0 is home city midnight on baseDate.
                // Convert to UTC offset: utcHour = hTotal - homeOffset
                // Then local hour for this city: localH = utcHour + offset = hTotal - homeOffset + offset
                for (let hTotal = 0; hTotal < TOTAL_HOURS; hTotal++) {
                    // utcHour relative to baseDate UTC midnight:
                    const utcHour = hTotal - homeOffset;
                    const localH = ((utcHour + offset) % 24 + 24) % 24;

                    const isBusiness = localH >= city.start && localH < city.end;
                    const isNight = localH >= 23 || localH < 7;
                    const typeClass = isBusiness ? 'block-business' : (isNight ? 'block-night' : 'block-day');

                    // Day boundary for THIS city: local hour just crossed midnight
                    const isDayBoundary = localH === 0 && hTotal > 0;

                    // End-of-business marker: this block is business but the next is not
                    const nextUtcHour = (hTotal + 1) - homeOffset;
                    const nextLocalH = ((nextUtcHour + offset) % 24 + 24) % 24;
                    const isEndOfBusiness = isBusiness && !(nextLocalH >= city.start && nextLocalH < city.end);

                    let markerHtml = '';
                    if (isDayBoundary) {
                        // Compute the local date at this boundary for the label
                        const utcMs = baseDate.getTime() + utcHour * 3600000;
                        const localDateObj = new Date(new Date(utcMs).toLocaleString('en-US', { timeZone: city.timezone }));
                        markerHtml = `<div class="date-marker-inline">${utils.formatDate(localDateObj)}</div>`;
                    }

                    hourBlocksHtml += `<div class="hour-block ${typeClass} ${city.isHome ? 'block-home' : ''} ${isDayBoundary ? 'block-day-boundary' : ''} ${isEndOfBusiness ? 'block-eod' : ''}">${markerHtml}${utils.formatHourLabel(localH, is24Hour).replace(' ', '')}</div>`;
                }

                row.innerHTML = `
                    <div class="w-[14rem] shrink-0 px-4 flex flex-col justify-center sticky left-0 z-20 bg-[#020617]/95 backdrop-blur-md border-r border-white/5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1.5 min-w-0">
                                <span class="text-sm font-black truncate max-w-[90px]">${city.name}</span>
                                ${homeBadge}${dstBadge}
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                                <button onclick="window.setHome(${index})" class="text-slate-500 hover:text-amber-400 p-1"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></button>
                                <button onclick="window.removeCity(${index})" class="text-slate-500 hover:text-red-400 p-1"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
                            </div>
                        </div>
                        <div class="flex items-baseline gap-2 mt-0.5">
                            <span class="text-[11px] font-black text-blue-400 font-mono">${localTimeStr.toLowerCase().replace(' ', '')}</span>
                            ${offsetLabel}
                        </div>
                        <div class="flex items-center gap-1.5 mt-1.5 bg-white/5 px-1.5 py-0.5 rounded-md border border-white/5 w-fit">
                            <svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-emerald-500 opacity-70"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/></svg>
                            <select onchange="window.updateBusinessHours(${index}, 'start', this.value)" class="bg-transparent text-[9px] text-slate-300 font-bold border-none p-0 outline-none cursor-pointer hover:text-emerald-400 transition-colors">
                                ${Array.from({length: 24}).map((_, i) => `<option value="${i}" ${city.start === i ? 'selected' : ''} class="bg-slate-900">${utils.formatHourLabel(i, is24Hour).replace(' ', '')}</option>`).join('')}
                            </select>
                            <span class="text-slate-600 text-[9px]">→</span>
                            <select onchange="window.updateBusinessHours(${index}, 'end', this.value)" class="bg-transparent text-[9px] text-slate-300 font-bold border-none p-0 outline-none cursor-pointer hover:text-emerald-400 transition-colors">
                                ${Array.from({length: 24}).map((_, i) => `<option value="${i}" ${city.end === i ? 'selected' : ''} class="bg-slate-900">${utils.formatHourLabel(i, is24Hour).replace(' ', '')}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center relative pr-4">
                        <div class="hours-grid relative">
                            ${hourBlocksHtml}
                        </div>
                    </div>
                `;
                citiesList.appendChild(row);
            });

            if (hasCommon) {
                const gridWidth = TOTAL_HOURS * BLOCK_WIDTH;
                // Convert UTC hours to home-city-anchored timeline hours (add homeOffset)
                let startTimeline = ((commonStartUTC + homeOffset) % 24 + 24) % 24;
                let endTimeline = ((commonEndUTC + homeOffset) % 24 + 24) % 24;
                if (startTimeline < endTimeline) {
                    commonTimeOverlay.classList.remove('hidden');
                    commonTimeOverlay.style.left = `${(startTimeline / TOTAL_HOURS) * gridWidth + OFFSET_X}px`;
                    commonTimeOverlay.style.width = `${((endTimeline - startTimeline) / TOTAL_HOURS) * gridWidth}px`;
                } else {
                    commonTimeOverlay.classList.add('hidden');
                }
            } else commonTimeOverlay.classList.add('hidden');

            // Now marker: position relative to home city midnight on baseDate
            // Timeline hour 0 = home city midnight = UTC hour (-homeOffset)
            // UTC ms for home midnight: baseDate + (-homeOffset)*3600000
            const homeMidnightUTC = baseDate.getTime() + (-homeOffset) * 3600000;
            const nowHours = (Date.now() - homeMidnightUTC) / 3600000;
            if (nowHours >= 0 && nowHours <= TOTAL_HOURS) {
                nowMarker.style.left = `${nowHours * BLOCK_WIDTH + OFFSET_X}px`;
                nowMarker.classList.remove('hidden');
            } else {
                nowMarker.classList.add('hidden');
            }

            // DST markers: one per city that has a transition within the 3-day window
            dstMarkersContainer.innerHTML = '';
            selectedCities.forEach(city => {
                const cityOffset = utils.getTimezoneOffset(city.timezone, baseDate);
                // Check up to 3 days ahead (within the visible 72h window)
                const dstInfo = utils.isDSTImminent(city.timezone, 3, baseDate);
                if (!dstInfo.imminent) return;

                // City midnight on the day of transition (home-time day daysUntil)
                // = UTC ms when that city's local clock crosses midnight on that day.
                // Approximate: start of that UTC day + city offset correction
                const dstDay = new Date(baseDate.getTime() + dstInfo.daysUntil * 24 * 3600000);
                dstDay.setUTCHours(0, 0, 0, 0);
                // City midnight UTC = dstDay - cityOffset hours
                const cityMidnightUTC_ms = dstDay.getTime() - cityOffset * 3600000;
                // Timeline hour = ms delta from home midnight / 1h
                const timelineH = (cityMidnightUTC_ms - homeMidnightUTC) / 3600000;

                if (timelineH < 0 || timelineH > TOTAL_HOURS) return;

                const leftPx = timelineH * BLOCK_WIDTH + OFFSET_X;
                const direction = dstInfo.nextOffset > dstInfo.currentOffset ? '▲ +1h' : '▼ −1h';

                const marker = document.createElement('div');
                marker.className = 'dst-marker';
                marker.style.left = `${leftPx}px`;

                const label = document.createElement('div');
                label.className = 'dst-marker-label';
                label.style.left = `${leftPx}px`;
                label.textContent = `DST ${city.name} ${direction}`;

                dstMarkersContainer.appendChild(marker);
                dstMarkersContainer.appendChild(label);
            });
        }

        let searchTimeout;
        citySearch.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            if (val.length < 2) { searchResults.classList.add('hidden'); return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=10&language=en&format=json`);
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        searchResults.innerHTML = data.results.map(m => `
                            <div class="px-4 py-2.5 hover:bg-blue-500/10 cursor-pointer flex justify-between items-center" onclick="window.addCity('${m.name}', '${m.timezone}')">
                                <div class="flex flex-col gap-0.5">
                                    <span class="text-[12px] font-bold text-slate-200">${m.name}</span>
                                    <span class="text-[8px] text-slate-500 uppercase tracking-widest">${m.admin1 || ''}${m.admin1 ? ', ' : ''}${m.country || ''}</span>
                                </div>
                                <span class="text-[8px] font-mono text-blue-400/50">${m.timezone}</span>
                            </div>
                        `).join('');
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.innerHTML = '<div class="px-4 py-3 text-[10px] text-slate-500 italic text-center">No cities found</div>';
                        searchResults.classList.remove('hidden');
                    }
                } catch (err) { console.error("Search error:", err); }
            }, 300);
        });

        citiesList.addEventListener('mousemove', (e) => {
            const rect = citiesList.getBoundingClientRect();
            const gridWidth = TOTAL_HOURS * BLOCK_WIDTH;
            const x = e.clientX - rect.left - OFFSET_X;
            if (x >= 0 && x <= gridWidth) {
                const timelineH = x / BLOCK_WIDTH;
                const snappedH = Math.round(timelineH * 4) / 4;
                const clampedH = Math.max(0, Math.min(TOTAL_HOURS, snappedH));
                const snappedPercent = (clampedH / TOTAL_HOURS) * 100;
                scrubber.style.left = `${(clampedH / TOTAL_HOURS) * gridWidth + OFFSET_X}px`;
                scrubber.classList.remove('hidden');
                showScrubberTooltip(snappedPercent, e.clientX, e.clientY);
            } else {
                scrubber.classList.add('hidden');
                scrubberTooltip.style.display = 'none';
            }
        });

        citiesList.addEventListener('mouseleave', () => {
            scrubber.classList.add('hidden');
            scrubberTooltip.style.display = 'none';
        });

        window.addCity = (name, timezone) => {
            if (!timezone || timezone === 'undefined' || timezone === 'null') { showToast('No timezone data available for this location.'); return; }
            if (!selectedCities.find(c => c.timezone === timezone)) selectedCities.push({ name, timezone, start: 9, end: 18, isHome: false });
            citySearch.value = ''; searchResults.classList.add('hidden'); render();
        };

        document.addEventListener('click', (e) => { if (!citySearch.contains(e.target)) searchResults.classList.add('hidden'); });
        render();
        fpInstance = flatpickr('#calendarPicker', {
            defaultDate: baseDate,
            dateFormat: 'Y-m-d',
            disableMobile: true,
            onChange: (selectedDates, dateStr) => setDate(dateStr),
        });
        setInterval(render, 60000);
    </script>
</body>
</html>
